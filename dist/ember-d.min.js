var D;D=Em.Namespace.create({VERSION:"0.1.0"}),D.attr=function(t,e){var r,n,i;return null==e&&(e={}),Em.assert("You must specify a serialized name",e.serialized_name=t),r="_data."+t,e.extra_keys||(e.extra_keys=[]),e.extra_keys instanceof Array||(e.extra_keys=[e.extra_keys]),e.extra_keys.unshift(r),i=e.extra_keys,delete e.extra_keys,n=function(t,n){var i;return void 0!==n?(this.set("isDirty",!0),e.convertTo?this.set(r,e.convertTo(n)):this.set(r,n),n):(i=this.get(r),void 0===i&&e.if_null&&(i="function"==typeof e.if_null?e.if_null.call(this):e.if_null),e.convertFrom?e.convertFrom(i):i)},n.property.apply(n,i).meta(e)},D.attr.moment=function(t,e){return null==e&&(e={}),e.convertFrom=function(t){return t?moment(t):void 0},e.convertTo=function(t){return t?t.toDate():void 0},D.attr(t,e)},D.attr.duration=function(t,e){var r;return null==e&&(e={}),r=e.unit||(e.unit="seconds"),e.convertFrom=function(t){return void 0!==t&&null!==t?moment.duration(t,r):void 0},e.convertTo=function(t){return t?t.as(r):void 0},D.attr(t,e)},D.attr.object=function(t,e){return null==e&&(e={}),e.convertFrom=function(t){return e.optional&&(t||(t={})),Em.ObjectProxy.create({content:t})},e.convertTo=function(t){return t.get("content")},D.attr(t,e)},D.attr.hasMany=function(t,e){var r;return null==e&&(e={}),t||Em.assert("You must specify model_name for hasMany"),e.urlBinding||Em.assert("You must specify urlBinding for hasMany"),r=function(){var r,n,i;return e.query||(e.query={}),(r=this.get("id"))&&(e.foreign_key||(e.foreign_key=""+Em.get(this.constructor,"singular")+"_id"),(n=e.query)[i=e.foreign_key]||(n[i]=this.get("id"))),D.RecordArrayRelation.create({parent:this,modelBinding:t,urlBinding:"parent."+e.urlBinding,query:e.query})}.property()},D.attr.belongsTo=function(t,e){var r,n,i;return null==e&&(e={}),t instanceof Object||Em.assert("You must specify attr_id: 'Assoc.Type' for belongsTo"),i=Em.keys(t)[0],r=t[i],e.typeString=r,n=null,e.convertFrom=function(t){return n||(n=e.type=Em.get(r)),t?n.find(t):void 0},e.convertTo=function(t){return t?t.get("id"):void 0},D.attr(i,e)},Em.onLoad("Ember.Application",function(t){return t.initializer({name:"store",initialize:function(t,e){return e.register("store:main",D.Store),e.set("defaultStore",t.lookup("store:main")),D.set("defaultStore",t.lookup("store:main"))}}),t.initializer({name:"injectStore",initialize:function(t,e){return e.inject("controller","store","store:main"),e.inject("route","store","store:main")}})}),D.Store=Em.Object.extend({_cache:{},ajax:function(t){return t.accepts||(t.accepts="application/json"),$.ajax.apply(this,arguments)},find:function(t,e){var r;return Em.assert("Cannot find a record without an id",e||null===e),t.constructor===String&&(t=this.container.lookup("model:"+t),Em.assert("Cannot find a record without a valid type",t instanceof D.Model),t=t.constructor),(r=this.findCached(t,e))?r:(r=this.load(t,{id:e},null,!0),r.reload(),r)},cache:function(t,e){var r,n,i,o;if(i=(o=this._cache)[t]||(o[t]={}),n=e.get("id")){if(r=i[n]){if(r===e)return;return i[n].set("content",e)}return i[n]=e}},findCached:function(t,e){var r,n;return Em.assert("Cannot find "+t+" without an id",e||null===e),r=(n=this._cache)[t]||(n[t]={}),r[e]},load:function(t,e,r,n){var i,o,a,s,u,l,c;if(e.errors){c=e.errors;for(o in c)u=c[o],Em.warn(""+o+" "+u.join("and"))}return e.id||null===e.id?(i=this.findCached(t,e.id),n&&i?i:(s=(l=this._cache)[t]||(l[t]={}),a=r||t.create(),n?a.set("id",e.id):a.load(e),s[e.id]=a)):(r||t.create()).load(e)}}),D.Store.reopenClass({alias:function(t){return function(){var e,r;return r=Em.get(D,"defaultStore"),e=[].slice.call(arguments),r[t].apply(r,e)}},aliasWithThis:function(t){return function(){var e,r;return r=Em.get(D,"defaultStore"),e=[].slice.call(arguments),e.unshift(this),r[t].apply(r,e)}}}),D.Model=Em.Object.extend(Em.Evented,{link:null,linkChange:function(){var t,e,r;return r=this.get("link"),t="_cacheBust="+(new Date).getTime(),-1===r.indexOf("_cacheBust")?(e=r.indexOf(!1)?"?":"&",r=""+r+e+t):r=r.replace(/([\?&])_cacheBust=\d+/,"$1"+t),this.set("link",r)},linkDidChange:function(){return this.get("isLoaded")?void 0:this.reload()}.observes("link"),_data:function(){return Em.Object.create()}.property(),toString:function(){return""+this.constructor+"("+this.get("id")+")"},id:D.attr("id",{readonly:!0}),created:D.attr.moment("created_at",{readonly:!0,optional:!0}),updated:D.attr.moment("updated_at",{readonly:!0,optional:!0}),errors:D.attr("errors",{readonly:!0,optional:!0}),links:D.attr.object("links",{readonly:!0,optional:!0}),idDidChange:function(){return this.constructor.cache(this)}.observes("id"),url:D.attr("url",{readonly:!0,extra_keys:["id","link"],if_null:function(){var t,e;return(e=this.get("link"))?(t=this.get("id")||null===t)?""+e+"/"+t:e:!1}}),then:function(t){return this.get("isLoaded")?t(this):(this.one("load",t),this.get("isLoading")?void 0:this.reload())},toJson:function(){var t,e=this;return t={},this.constructor.eachComputedProperty(function(r,n){var i,o;if(!n.readonly)return(i=n.serialized_name)&&(o=e.get(r),n.convertTo&&(o=n.convertTo(o)),void 0!==o)?t[i]=o:void 0}),t},isDeleted:!1,isLoading:!1,isLoaded:!1,isNew:function(){return void 0===this.get("id")}.property("id"),isDirty:function(t,e){return void 0!==e?e:this.get("id")?!1:!0}.property("id"),ajax:function(){return this.constructor.ajax.apply(this,arguments)},load:function(t){var e,r,n;if("function"==typeof t)return this.one("load",this,t);if(Em.assert("Load with no data?","object"==typeof t),t.errors){n=t.errors;for(e in n)r=n[e],Em.warn(""+this.get("url")+" - "+e+" "+r.join("and"))}return this.constructor._needsBeforeLoad&&this.constructor._beforeLoad(t),this.set("_data",Em.Object.create(t)),this.set("isDirty",!1),this.set("isLoaded",!0),this.set("isLoading",!1),this.trigger("load",this),this},cancel:function(){return this.reload()},reload:function(){var t,e,r=this;return t=this.get("id"),void 0===t?this:(e=this.get("url"))?(this.set("isLoaded",!1),this.set("isLoading",!0),this.ajax({url:e,cache:!1,success:function(t){return r.constructor.fromJson(t,r)},error:function(){}}),this):this},"delete":function(){var t=this;return this.get("id")&&this.ajax(this.get("url"),{method:"delete",success:function(){return t.linkChange()}}),this.set("isDeleted",!0),this.set("_data",null)},save:function(t){var e=this;return t&&this.load(t),new Em.RSVP.Promise(function(t,r){var n,i,o;return e.get("link")?(console.log("saving"),Em.assert("Cannot save without a link or url",o=e.get("url")),i=e.get("id")?"put":"post",n={},n[Em.get(e.constructor,"singular")]=e.toJson(),e.get("isDirty")?e.ajax({method:i,contentType:"application/json; charset=utf-8",dataType:"json",processData:!1,url:o,data:JSON.stringify(n),success:function(r){return e.load(r[Em.get(e.constructor,"singular")]),e.linkChange(),t()},error:function(t){return r(t)}}):t()):(console.log("deferring"),e.addObserver("link",e,function(){return this.save().then(t,r)}))})}}),D.Model.reopenClass({find:D.Store.aliasWithThis("find"),cache:D.Store.aliasWithThis("cache"),load:D.Store.aliasWithThis("load"),ajax:D.Store.alias("ajax"),_beforeLoad:function(t){var e,r,n,i,o,a=this;return this._needsBeforeLoad=!1,e=this.attributes(),r={},i=Em.keys(t),n=Em.keys(e),o=!1,$.each(n,function(n,s){var u,l;return l=e[s].serialized_name,u=e[s].optional,r[l]=e[s],void 0!==t[l]||u?void 0:(o||(o=!0,Em.warn(""+a+": potential issues with model attributes after receiving "+i)),Em.warn(""+a+" has extranious attr mapping for: "+l+" on property "+s))}),$.each(i,function(t,e){return void 0===r[e]?Em.warn(""+a+" is missing attr mapping for: "+e):void 0})},_needsBeforeLoad:!0,attributes:function(){var t;return t={},this.eachComputedProperty(function(e,r){var n;return(n=r.serialized_name)?t[e]=r:void 0}),t},singular:function(){return this.toString().split(".").pop().underscore()}.property(),plural:function(){return Em.assert("Please define a plural plural: 'plural' for "+this.constructor)}.property("singular"),fromJson:function(t,e){var r,n,i=this;return n=Em.get(this,"singular"),t[n]?this.load(t[n],e):(Em.assert("Cannot load into an instance without the singular: "+n,!e),r=Em.get(this,"plural"),Em.assert("Cannot load without singular: "+n+" or plural: "+r,t[r]),t[r].map(function(t){return i.load(t)}))},create:function(t){return this._super().setProperties(t)}}),D.RecordArray=Em.ArrayProxy.extend(Em.Evented,{ajax:D.Store.alias("ajax"),url:null,query:null,_model:function(){var t;return t=this.get("model"),t.create()}.property(),model:null,isLoaded:!1,isLoading:!1,extractMeta:function(){return null},success:function(t){var e;return Em.assert("You must specify a model or a success converter",e=this.get("model")),e.fromJson(t)},error:function(){},content:function(t,e){return this._inited||this._init(),void 0!==e?e:(this.urlOrQueryDidChange(),[])}.property(),_init:function(){return this._inited=!0,this._setupContent(),this._setupArrangedContent()},init:function(){return this._inited=!1},load:function(t){return this.get("isLoaded")?t.apply(this):(this.urlOrQueryDidChange(),this.one("load",this,t))},reload:function(t){return null==t&&(t={}),this.set("query",$.extend({},this.get("query"),t))},urlOrQueryDidChange:function(t,e){var r,n,i=this;if(this._inited&&this.get("_model.link")&&(n=this.get("url"))&&(e||!this.get("isLoading")))return r=this.get("query"),this.set("isLoaded",!1),this.set("isLoading",!0),console.log(""+this+"::"+this.get("model").toString()+".loading("+e+":"+(e?this.get(e):void 0)+")",r),this.ajax({method:"get",url:n,data:r}).success(function(t){return i.isDestroyed?void 0:(i.extractMeta(t),i.set("content",i.success(t)),i.set("isLoaded",!0),i.set("isLoading",!1),i.trigger("load",i))}).error(function(t){return i.error(t,n,r)})}.observes("query","url","_model.link")}),D.RecordArrayPaged=D.RecordArray.extend({page:function(t,e){return void 0!==e?(this.reload({page:e}),e):this.get("query.page")||1}.property("query.page"),totalRecords:null,totalPages:null,perPage:null,nextPageUrl:null,previousPageUrl:null,hasNextPageBinding:"nextPageUrl",hasPreviousPageBinding:"previousPageUrl",nextPage:function(){return this.set("url",this.get("nextPageUrl"))},previousPage:function(){return this.set("url",this.get("previousPageUrl"))},extractMeta:function(t){return this.setProperties({perPage:t.meta.per_page,totalRecords:t.meta.total_records,totalPages:t.meta.total_pages,nextPageUrl:t.links.next_page,previousPageUrl:t.links.previous_page})}}),D.RecordArrayRelation=D.RecordArray.extend({_parent:null,parent:null,init:function(){return this._super.apply(this,arguments)},where:function(t){var e,r;return null==t&&(t={}),r=this.get("query"),e=$.extend(r,t),D.RecordArrayRelation.create({_parent:this,urlBinding:"_parent.url",modelBinding:"_parent.model",query:e})},nextNew:function(){return this.create()}.property(),nextNewIsntNew:function(){return this.get("nextNew.id")?this.set("nextNew"):void 0}.observes("nextNew.id"),create:function(t){var e,r;return null==t&&(t={}),e=this.get("model"),r=this.get("query"),e.create($.extend(r,t))}});