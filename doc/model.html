<!DOCTYPE html>

<html>
<head>
  <title>model.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>model.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="example-app.html">
                    example-app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="emd.html">
                    emd.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="attr.html">
                    attr.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="belongs_to.html">
                    belongs_to.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="has_many.html">
                    has_many.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="moment.html">
                    moment.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="object.html">
                    object.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="initializer.html">
                    initializer.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="model.html">
                    model.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="record_array.html">
                    record_array.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="paged.html">
                    paged.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="relation.html">
                    relation.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="store.html">
                    store.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <!--
= require ./store
-->


<p>Models are collections of attributes, that can be persisted via HTTP methods
on a specified path or <code>link</code>.</p>
<h2>Basic Usage</h2>

        
      
        
        <p>Creating a model that maps the following json document:</p>
<pre><code>user:
  id: 1
  name: &quot;Carl&quot;
  email_address: &quot;carl@yay.com&quot;</code></pre>
<p>Located at <code>/api/users/1</code></p>
<p>Add a link property to your application for the model:</p>
<pre><code>App = Em.Application.create
  userLink: &quot;/api/users&quot;</code></pre>
<p>Define the model class:</p>
<pre><code>App.User = EMD.Model.extend
  linkBinding: &quot;App.userLink&quot;
  name: EMD.attr &quot;name&quot;
  emailAddress: EMD.attr &quot;email_address&quot;</code></pre>
<p>And then use it in your application:</p>
<pre><code>u = App.User.find 1
u.get &quot;name&quot;          =&gt; &quot;carl&quot;
u.get &quot;emailAddress&quot;  =&gt; &quot;carl@yay.com&quot;
u.get &quot;link&quot;          =&gt; &quot;/api/users&quot;
u.get &quot;url&quot;           =&gt; &quot;/api/users/1&quot;</code></pre>
<h2>Annotated source</h2>

        
      
        
        
        
          <div class='highlight'><pre>EMD.Model = Em.Object.extend Em.Evented,</pre></div>
        
      
        
        <h2>Link</h2>

        
      
        
        <p>The <code>link</code> property  defines the resource path for <strong>all</strong> models of a type.</p>
<p>For example, all <code>App.User</code> models would share a <code>link</code> like <code>/api/users</code></p>
<p>The link is special because it defines the basic path for retrieving,
creating, updating, and deleting models.</p>
<p>When the <code>link</code> changes, all models of that type reload. All record arrays
that use that type as a base reload.</p>

        
          <div class='highlight'><pre>  link: <span class="literal">null</span>

  linkChange: -&gt;
    link = <span class="property">@get</span> <span class="string">'link'</span>
    cachebust = <span class="string">"_cacheBust=<span class="subst">#{<span class="keyword">new</span> Date().getTime()}</span>"</span>
    <span class="keyword">if</span> link.indexOf(<span class="string">'_cacheBust'</span>) == -<span class="number">1</span>
      <span class="keyword">if</span> link.indexOf <span class="string">'?'</span> == -<span class="number">1</span>
        connector = <span class="string">'?'</span>
      <span class="keyword">else</span>
        connector = <span class="string">'&amp;'</span>
      link = <span class="string">"<span class="subst">#{link}</span><span class="subst">#{connector}</span><span class="subst">#{cachebust}</span>"</span>
    <span class="keyword">else</span>
      link = link.replace <span class="regexp">/([\?&amp;])_cacheBust=\d+/</span>, <span class="string">"$1<span class="subst">#{cachebust}</span>"</span>
    <span class="property">@set</span> <span class="string">'link'</span>, link

  linkDidChange: (-&gt;
    <span class="property">@reload</span>() <span class="keyword">unless</span> <span class="property">@get</span> <span class="string">"isLoaded"</span>
  ).observes <span class="string">"link"</span></pre></div>
        
      
        
        <h2>Url</h2>

        
      
        
        <p>The <code>url</code> property is different than the link in that it is the link with
the model&#39;s <code>id</code> property appended to it.</p>
<p>See <a href="attr.html">EMD.attr</a> for more documentation on <code>EMD.attr</code>.</p>

        
          <div class='highlight'><pre>  url: EMD.attr <span class="string">'url'</span>,
    readonly: <span class="literal">true</span>
    extra_keys: [<span class="string">'id'</span>, <span class="string">'link'</span>]
    if_null: -&gt;
      <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> link = <span class="property">@get</span> <span class="string">"link"</span>
      <span class="keyword">return</span> link <span class="keyword">unless</span> id = <span class="property">@get</span>(<span class="string">"id"</span>) <span class="keyword">or</span> id == <span class="literal">null</span>
      <span class="string">"<span class="subst">#{link}</span>/<span class="subst">#{id}</span>"</span></pre></div>
        
      
        
        <h2>Id</h2>

        
      
        
        <p>This is id of the object, it is set to readonly because it is present in the
url that actions are performed on.</p>
<p>For example, <code>App.User.find(1).get(&quot;url&quot;)</code> would return <code>/api/users/1</code>.</p>
<p>When the id changes and becomes present, the record is cached in the store
cache.</p>

        
          <div class='highlight'><pre>  id: EMD.attr <span class="string">'id'</span>, readonly: <span class="literal">true</span>

  idDidChange: (-&gt;
    <span class="property">@constructor</span>.cache(@)
  ).observes(<span class="string">"id"</span>)</pre></div>
        
      
        
        <h2>then</h2>

        
      
        
        <p>This is a ghetto promise interface, it allows this model to behave
asynchronously with EmberJS&#39;s routing system as well as providing a helper
for telling when the model is loaded or if it already is</p>

        
          <div class='highlight'><pre>  <span class="keyword">then</span>: (ok, er)-&gt;
    <span class="keyword">return</span> ok(@) <span class="keyword">if</span> <span class="property">@get</span> <span class="string">'isLoaded'</span>
    <span class="keyword">return</span> ok(@) <span class="keyword">unless</span> <span class="property">@get</span> <span class="string">'id'</span>
    <span class="property">@one</span> <span class="string">'load'</span>, ok
    <span class="property">@reload</span>()

  toString: -&gt;
    <span class="string">"<span class="subst">#{@constructor}</span>(<span class="subst">#{@get 'id' }</span>)"</span>

  toJson: -&gt;
    props = {}
    <span class="property">@constructor</span>.eachComputedProperty (name, meta)=&gt;
      <span class="keyword">return</span> <span class="keyword">if</span> meta.readonly
      <span class="keyword">if</span> serialized_name = meta.serialized_name
        value = <span class="property">@get</span> name
        value = meta.convertTo(value) <span class="keyword">if</span> meta.convertTo
        props[serialized_name] = value <span class="keyword">if</span> value != <span class="literal">undefined</span>
    props</pre></div>
        
      
        
        <h2>_data</h2>

        
      
        
        <p>The <code>_data</code> object is where the data from the server is stored.</p>

        
          <div class='highlight'><pre>  _data: (-&gt;
    Em.Object.create()
  ).property()</pre></div>
        
      
        
        <h2>ajax</h2>

        
      
        
        <p>Here we defer our ajax to our constructor, which allows each model to
override it&#39;s ajax method.</p>

        
          <div class='highlight'><pre>  ajax: -&gt;
    <span class="property">@constructor</span>.ajax.apply @, arguments</pre></div>
        
      
        
        <h2>load</h2>

        
      
        
        <p>This forcefully injects json ito the <code>_data</code> field and extracts
errors that the developer should see.</p>
<p>If the json document has a <code>errors</code> object in it, the errors will be logged
to the console and available on the model.</p>

        
          <div class='highlight'><pre>  load: (data)-&gt;
    Em.assert <span class="string">"Load with no data?"</span>, <span class="keyword">typeof</span> data == <span class="string">'object'</span>

    <span class="keyword">if</span> data.errors
      <span class="keyword">for</span> key, value <span class="keyword">of</span> data.errors
        Em.warn <span class="string">"<span class="subst">#{@get('url')}</span> - <span class="subst">#{key}</span> <span class="subst">#{value.join("<span class="keyword">and</span>")}</span>"</span>

    <span class="keyword">if</span> <span class="property">@constructor</span>._needsBeforeLoad
      <span class="property">@constructor</span>._beforeLoad(data)</pre></div>
        
      
        
        <p>Load the data into our model</p>

        
          <div class='highlight'><pre>    <span class="property">@set</span> <span class="string">"_data"</span>, Em.Object.create data</pre></div>
        
      
        
        <p>Set our state to loaded</p>

        
          <div class='highlight'><pre>    <span class="property">@set</span> <span class="string">"isDirty"</span>, <span class="literal">false</span>
    <span class="property">@set</span> <span class="string">"isLoaded"</span>, <span class="literal">true</span>
    <span class="property">@set</span> <span class="string">"isLoading"</span>, <span class="literal">false</span></pre></div>
        
      
        
        <p>Fire triggers</p>

        
          <div class='highlight'><pre>    <span class="property">@trigger</span> <span class="string">'load'</span>, @
    @</pre></div>
        
      
        
        <h2>reload</h2>

        
      
        
        <p>If the model has an id, it triggers a fetch from the server.</p>

        
          <div class='highlight'><pre>  reload: -&gt;
    id = <span class="property">@get</span>(<span class="string">"id"</span>)
    <span class="keyword">return</span> @ <span class="keyword">if</span> id == <span class="literal">undefined</span>
    <span class="keyword">return</span> @ <span class="keyword">unless</span> url = <span class="property">@get</span> <span class="string">"url"</span>

    <span class="property">@set</span> <span class="string">"isLoaded"</span>, <span class="literal">false</span>
    <span class="property">@set</span> <span class="string">"isLoading"</span>, <span class="literal">true</span>

    <span class="property">@ajax</span>
      url: url
      cache: <span class="literal">false</span>
      success: (ok)=&gt;
        <span class="property">@constructor</span>.fromJson(ok, @)
      error: (err)=&gt;
        <span class="keyword">debugger</span>

  <span class="keyword">delete</span>: -&gt;
    <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">"id"</span>)
      <span class="property">@ajax</span> <span class="property">@get</span>(<span class="string">"url"</span>),
        method: <span class="string">'delete'</span>
        success: (rsp)=&gt;
          <span class="property">@linkChange</span>()
    <span class="property">@set</span> <span class="string">'isDeleted'</span>, <span class="literal">true</span>
    <span class="property">@set</span> <span class="string">'_data'</span>, <span class="literal">null</span>

  save: (ok)-&gt;
    <span class="property">@load</span>(ok) <span class="keyword">if</span> ok

    <span class="keyword">new</span> Em.RSVP.Promise (ok, er)=&gt;
      <span class="keyword">unless</span> <span class="property">@get</span> <span class="string">"link"</span>
        console.log <span class="string">"deferring"</span>
        <span class="property">@addObserver</span> <span class="string">"link"</span>, @, -&gt;
          <span class="property">@save</span>().<span class="keyword">then</span>(ok, er)
      <span class="keyword">else</span>
        console.log <span class="string">"saving"</span>
        Em.assert <span class="string">"Cannot save without a link or url"</span>, url = <span class="property">@get</span> <span class="string">"url"</span>
        method = <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">"id"</span>) <span class="keyword">then</span> <span class="string">"put"</span> <span class="keyword">else</span> <span class="string">"post"</span>
        data = {}
        data[Em.get(<span class="property">@constructor</span>, <span class="string">'singular'</span>)] = <span class="property">@toJson</span>()

        <span class="keyword">return</span> ok() <span class="keyword">unless</span> <span class="property">@get</span> <span class="string">'isDirty'</span>
        <span class="property">@ajax</span>
          method: method
          contentType: <span class="string">"application/json; charset=utf-8"</span>
          dataType: <span class="string">"json"</span>
          processData: <span class="literal">false</span>
          url: url
          data: JSON.stringify data
          success: (rsp)=&gt;
            <span class="property">@load</span> rsp[Em.get(<span class="property">@constructor</span>, <span class="string">"singular"</span>)]</pre></div>
        
      
        
        <p>We need to inform all record arrays off this link
that we have changed their contents</p>

        
          <div class='highlight'><pre>            <span class="property">@linkChange</span>()

            ok()
          error: (rsp)-&gt;
            er(rsp)

  isDeleted: <span class="literal">false</span>
  isLoading: <span class="literal">false</span>
  isLoaded: <span class="literal">false</span>
  isNew: (-&gt;<span class="keyword">return</span> <span class="property">@get</span>(<span class="string">'id'</span>) == <span class="literal">undefined</span>).property <span class="string">'id'</span>
  isDirty: ((_, set)-&gt;
    <span class="keyword">return</span> set <span class="keyword">if</span> set != <span class="literal">undefined</span>
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="property">@get</span> <span class="string">"id"</span>
    <span class="literal">true</span>
  ).property <span class="string">"id"</span>


  created: EMD.attr.moment <span class="string">'created_at'</span>, readonly: <span class="literal">true</span>, optional: <span class="literal">true</span>
  updated: EMD.attr.moment <span class="string">'updated_at'</span>, readonly: <span class="literal">true</span>, optional: <span class="literal">true</span>
  errors: EMD.attr <span class="string">'errors'</span>, readonly: <span class="literal">true</span>, optional: <span class="literal">true</span>
  links: EMD.attr.object <span class="string">'links'</span>, readonly: <span class="literal">true</span>, optional: <span class="literal">true</span></pre></div>
        
      
        
        <h2>Model class methods and properties</h2>

        
      
        
        
        
          <div class='highlight'><pre>EMD.Model.reopenClass
  find: EMD.Store.aliasWithThis <span class="string">'find'</span>
  cache: EMD.Store.aliasWithThis <span class="string">'cache'</span>
  load: EMD.Store.aliasWithThis <span class="string">'load'</span>
  ajax: EMD.Store.alias <span class="string">'ajax'</span>

  extend: -&gt;
    args = Array.prototype.slice.call arguments
    args = $.map args, (arg)-&gt;
      console.log arg <span class="keyword">if</span> arg <span class="keyword">instanceof</span> Function
    attributes = <span class="property">@attributes</span>()
    has_serialized_keys = {}
    serialized_keys = Em.keys data
    property_keys = Em.keys attributes
    shown_data = <span class="literal">false</span>

    $.each property_keys, (_, property_key)=&gt;
      serialized_name = attributes[property_key].serialized_name
      optional = attributes[property_key].optional
      has_serialized_keys[serialized_name] = attributes[property_key]
      <span class="keyword">if</span> data[serialized_name] == <span class="literal">undefined</span> &amp;&amp; !optional
        <span class="keyword">unless</span> shown_data
          shown_data = <span class="literal">true</span>
          Em.warn <span class="string">"<span class="subst">#{@}</span>: potential issues with model attributes after receiving <span class="subst">#{serialized_keys}</span>"</span>
        Em.warn <span class="string">"<span class="subst">#{@}</span> has extranious attr mapping for: <span class="subst">#{serialized_name}</span> on property <span class="subst">#{property_key}</span>"</span>


    $.each serialized_keys, (_, serialized_key)=&gt;
      Em.warn <span class="string">"<span class="subst">#{@}</span> is missing attr mapping for: <span class="subst">#{serialized_key}</span>"</span> <span class="keyword">if</span> has_serialized_keys[serialized_key] == <span class="literal">undefined</span>

  _needsBeforeLoad: <span class="literal">true</span>

  attributes: -&gt;
    attributes = {}
    <span class="property">@eachComputedProperty</span> (name, meta)=&gt;
      attributes[name] = meta <span class="keyword">if</span> serialized_name = meta.serialized_name
    attributes

  fromJson: (data, instance)-&gt;</pre></div>
        
      
        
        <p>Try to load singular</p>

        
          <div class='highlight'><pre>    singular = Em.get(@, <span class="string">"singular"</span>)
    <span class="keyword">return</span> <span class="property">@load</span>(data[singular], instance) <span class="keyword">if</span> data[singular]
    Em.assert <span class="string">"Cannot load into an instance without the singular: <span class="subst">#{singular}</span>"</span>, !instance</pre></div>
        
      
        
        <p>Try to load plural</p>

        
          <div class='highlight'><pre>    plural = Em.get(@, <span class="string">"plural"</span>)
    Em.assert <span class="string">"Cannot load without singular: <span class="subst">#{singular}</span> or plural: <span class="subst">#{plural}</span>"</span>, data[plural]
    data[plural].map((data)=&gt;
      <span class="property">@load</span>(data))

  create: (config)-&gt;
    <span class="property">@_super</span>().setProperties config</pre></div>
        
      
        
        <h2>Inflection</h2>

        
      
        
        <p>The singular is often derivable by the class name, however, the plural is more
difficult.</p>
<p>There is default support for the inflector found here
<a href="http://msnexploder.github.io/inflect/"><a href="http://msnexploder.github.io/inflect/">http://msnexploder.github.io/inflect/</a></a>.</p>
<p>Or you can add your own: <code>EMD.Model.set &#39;pluralizer&#39;, (model)-&gt; model.toString().split(&#39;.&#39;).pop().underscore() + &quot;s&quot;</code></p>

        
          <div class='highlight'><pre>  singular: (-&gt;
    <span class="property">@toString</span>().split(<span class="string">"."</span>).pop().underscore()
  ).property()

  pluralizer: (-&gt;
    <span class="keyword">if</span> inflect != <span class="literal">undefined</span>
      (model)-&gt;
        name = model.toString().split(<span class="string">'.'</span>).pop().underscore()
        inflect.pluralize(name)
  ).property()

  plural: (-&gt;
    <span class="keyword">if</span> pluralize = Em.get @, <span class="string">"pluralizer"</span>
      <span class="keyword">return</span> pluralize @
    Em.assert <span class="string">"Please define a plural plural: 'plural' for <span class="subst">#{@constructor}</span> or register a pluralizer with EMD.Model.set('pluralizer', ((model)-&gt;'models')"</span>
  ).property <span class="string">"singular"</span></pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
